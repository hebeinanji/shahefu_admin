kind: pipeline
type: docker
name: build-and-push

steps:
  - name: docker-build
    image: plugins/docker
    settings:
      registry: harbor.shahefu.com  # Docker é•œåƒä»“åº“
      repo: harbor.shahefu.com/shahefu/admin_front
      tags:
        - latest
        - ${DRONE_COMMIT_BRANCH}
        - ${DRONE_BUILD_NUMBER}
      dockerfile: Dockerfile  # æŒ‡å®š Dockerfile
      context: .  # æŒ‡å®šæ„å»ºä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤æ˜¯å½“å‰ç›®å½•ï¼‰
      username:
        from_secret: username
      password:
        from_secret: secret

  - name: upload-image-tencent-cos
    timeout: 30
    image: appleboy/drone-ssh
    pull: if-not-exists # always never
    settings:
      host: 43.163.245.139 #ä¸œäº¬æœºæˆ¿
      username: root
      port: 22
      password:
        from_secret: tencent_ssh_password
      script:
        - cd /data/coscli || true
        - echo "$HARBOR_PASSWORD" | docker login harbor.shahefu.com -u "$HARBOR_USERNAME" --password-stdin || true
        - docker pull harbor.shahefu.com/shahefu/admin_front:latest || true
        - docker save -o admin_front.tar harbor.shahefu.com/shahefu/admin_front:latest || true
        - gzip -c admin_front.tar > admin_front.tar.gz || true
        - coscli -c coscli_conf.yaml cp admin_front.tar.gz cos://images-tokyo-1/drone-images/admin_front-${DRONE_BUILD_NUMBER}.tar.gz || true
        - rm -rf admin_front.tar.gz || true
        - docker image rm harbor.shahefu.com/shahefu/admin_front:latest || true
      environment:
        TENCENT_SECRET_ID:
          from_secret: tencent_secret_id
        TENCENT_SECRET_KEY:
          from_secret: tencent_secret_key
        HARBOR_USERNAME:
          from_secret: username
        HARBOR_PASSWORD:
          from_secret: secret

trigger:
  branch:
    - main
  event:
    - custom
---

kind: pipeline
type: docker
name: deploy-production

clone:
  disable: true  # ç¦ç”¨å…‹éš†ä»£ç ï¼Œæé«˜éƒ¨ç½²é€Ÿåº¦

steps:
  - name: deploy-to-server
    image: appleboy/drone-ssh
    pull: if-not-exists # always never
    settings:
      host:
        - 43.163.245.139 #è…¾è®¯äº‘ä¸œäº¬
      username: root
      port: 22
      password:
        from_secret: tencent_ssh_password
      script:
        - cd /data/coscli || true
        - coscli -c coscli_conf.yaml cp cos://images-tokyo-1/drone-images/admin_front-${DRONE_BUILD_PARENT}.tar.gz admin_front.tar.gz
        - echo "ğŸ”§ è§£å‹ $TAR_FILE å¹¶åŠ è½½ Docker é•œåƒ..."
        - gzip -dc admin_front.tar.gz | docker load
        - echo "âœ… é•œåƒåŠ è½½å®Œæˆ"
        - rm -rf admin_front.tar.gz admin_front.tar
        - cd /data/app/SslAdmin
        - docker-compose stop admin_front
        - docker-compose rm -f admin_front
        - docker-compose up -d admin_front
        - docker image prune -f

trigger:
  event:
    - promote
  target:
    - production